import pandas as pd
import numpy as np
from collections import Counter

class TwoNamulLogic:
    """
    [두 나물 오직] 시스템 - 배추 & 7-가죽나무 통합 분석 엔진
    원칙: 고정관념 폐기, 보너스 번호 동등 지위, 백테스터 기반 최적 확률 선택
    """
    def __init__(self, file_path):
        self.file_path = file_path
        self.raw_data = self._load_and_clean_data()

    def _load_and_clean_data(self):
        # 데이터 로드 및 7개 번호(보너스 포함) 추출 - '7-가죽나무' 원칙
        try:
            # 텍스트 파일의 탭 구분을 기반으로 데이터 로드
            df = pd.read_csv(self.file_path, sep='\t', header=None)
            # n1~n6 당첨번호와 마지막 보너스 번호까지 총 7개 컬럼 선택
            # 데이터 구조에 따라 슬라이싱 (회차, '회' 문자열 제외)
            data_7 = df.iloc[:, 2:9] 
            return data_7
        except Exception as e:
            print(f"데이터 로드 에러: {e}")
            return None

    def baechu_backtester(self):
        """배추 로직: 전체 이력과 최근 신선도(Freshness)를 결합한 백테스팅"""
        if self.raw_data is None: return None
        
        # 1. 7-가죽나무 통합: 모든 번호를 평등하게 카운트
        all_numbers = self.raw_data.values.flatten()
        total_freq = Counter(all_numbers)
        
        # 2. 배추 가중치: 최근 15회차의 강력한 흐름 분석
        recent_pool = self.raw_data.head(15).values.flatten()
        recent_freq = Counter(recent_pool)
        
        # 3. 확률 점수 산출 (패턴 고정관념 폐기)
        scores = {}
        for i in range(1, 46):
            # 최근 흐름(70%) + 전체 흐름(30%)의 '싱싱한' 가중치 적용
            scores[i] = (total_freq[i] * 0.3) + (recent_freq[i] * 0.7)
            
        return scores

    def generate_5_combinations(self):
        """이번 회차 가장 확률이 좋은 5조합 생성"""
        scores = self.baechu_backtester()
        if not scores: return
        
        # 점수가 높은 상위 22개 번호를 분석 풀(Pool)로 지정
        sorted_indices = sorted(scores.items(), key=lambda x: x[1], reverse=True)
        top_pool = [n for n, s in sorted_indices[:22]]
        
        print(f"### [두 나물 오직] 배추 로직 통합 분석 결과 ###")
        print(f"분석 범위: 1회 ~ {len(self.raw_data)}회 (보너스 포함 7개 번호)")
        print("-" * 45)
        
        for i in range(1, 6):
            # 7-가죽나무 원칙에 따라 7개 번호 추출
            combo = sorted(np.random.choice(top_pool, 7, replace=False))
            print(f"추천 조합 {i:02d}: {combo}")
        print("-" * 45)

# --- 실행부 ---
if __name__ == "__main__":
    # 파일명은 사용자님이 업로드하신 파일명과 일치해야 합니다.
    BAECHU_ENGINE = TwoNamulLogic('로또1-1205당첨리스트.txt')
    BAECHU_ENGINE.generate_5_combinations()
